const a6_0x5519=['env','readdirSync','DistributedAgentApi','targets','CIRCLE_STAGE','throw','ENCRYPTION_KEY','encryptionKey','some','Critical\x20Error\x20in\x20Agent:\x20\x22','../../file-storage/e2e-encryption','../../error/print-run-group-error','floor','includes','tasksRunnerOptions','join','../../error/print-invalid-runner-error','note','exit','Distributed\x20Task\x20Execution\x20is\x20disabled\x20when\x20your\x20workspace\x20is\x20disabled','./invoke-tasks-using-nx-imperative-api','map','End\x20all\x20currently\x20running\x20agents,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22,\x20and\x20try\x20again.','ErrorReporterApi','../../file-storage/file-storage','readFileSync','__awaiter','split','We\x20have\x20detected\x20other\x20agents\x20running\x20in\x20this\x20workspace.\x20This\x20can\x20cause\x20unexpected\x20behavior.','Other\x20Nx\x20Cloud\x20Agents\x20Detected','strip-json-comments','message','NX_AGENT_NAME','./invoke-tasks-using-run-many','Nx\x20Cloud:\x20Workspace\x20is\x20disabled','../../../utilities/is-workspace-enabled','argv','Agent\x20was\x20terminated\x20via\x20SIGINT','existsSync','Organization\x20administrators\x20can\x20find\x20more\x20information\x20on\x20the\x20\x27Billing\x20and\x20Plans\x27\x20page\x20in\x20the\x20Nx\x20Cloud\x20Webapp','trim','printInvalidRunnerError','value','We\x20have\x20detected\x20another\x20agent\x20with\x20this\x20ID\x20running\x20in\x20this\x20workspace.\x20This\x20should\x20not\x20happen.','SIGINT','submitRunMetrics','../../../utilities/nx-imports','executeTasks','next','yargs-parser','done','length','CIRCLE_JOB','./distributed-agent.api','isWorkspaceEnabled','nx-cloud','error','filter','This\x20can\x20also\x20be\x20a\x20false\x20positive\x20caused\x20by\x20agents\x20that\x20did\x20not\x20shut\x20down\x20correctly.','canDetectRunGroup','__esModule','parse','getRunGroup','getCIExecutionId','writeFileSync','DteArtifactStorage','../../../utilities/metric-logger','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20tasks','Agent\x20was\x20terminated\x20via\x20SIGTERM','runner','Duplicate\x20Agent\x20ID\x20Detected','random','E2EEncryption','getBranch','warn','toString','printRunGroupError','then','startAgent','Agent\x20','/lockfiles','FileStorage','@nrwl/nx-cloud','CIRCLECI','cacheableOperations','Starting\x20an\x20agent\x20for\x20running\x20Nx\x20target(s)\x20[','getCIExecutionEnv','.lock','If\x20you\x20believe\x20this\x20is\x20the\x20case,\x20run\x20\x22npx\x20nx-cloud\x20clean-up-agents\x22.','unlinkSync','completeRunGroupWithError'];(function(_0xef0481,_0x55195e){const _0x6929e=function(_0x4492f){while(--_0x4492f){_0xef0481['push'](_0xef0481['shift']());}};_0x6929e(++_0x55195e);}(a6_0x5519,0xa2));const a6_0x6929=function(_0xef0481,_0x55195e){_0xef0481=_0xef0481-0x0;let _0x6929e=a6_0x5519[_0xef0481];return _0x6929e;};'use strict';var __awaiter=this&&this[a6_0x6929('0x2e')]||function(_0x3874a0,_0x170d08,_0x368b51,_0x747716){function _0x635229(_0x3a479f){return _0x3a479f instanceof _0x368b51?_0x3a479f:new _0x368b51(function(_0x4b3288){_0x4b3288(_0x3a479f);});}return new(_0x368b51||(_0x368b51=Promise))(function(_0x137945,_0x4baaa1){function _0x2be676(_0x8a38e1){try{_0x3f620c(_0x747716['next'](_0x8a38e1));}catch(_0x523ed0){_0x4baaa1(_0x523ed0);}}function _0x593d72(_0x2347de){try{_0x3f620c(_0x747716[a6_0x6929('0x19')](_0x2347de));}catch(_0x569151){_0x4baaa1(_0x569151);}}function _0x3f620c(_0xa7950e){_0xa7950e[a6_0x6929('0x46')]?_0x137945(_0xa7950e[a6_0x6929('0x3e')]):_0x635229(_0xa7950e['value'])[a6_0x6929('0x6')](_0x2be676,_0x593d72);}_0x3f620c((_0x747716=_0x747716['apply'](_0x3874a0,_0x170d08||[]))[a6_0x6929('0x44')]());});};Object['defineProperty'](exports,a6_0x6929('0x50'),{'value':!![]});exports[a6_0x6929('0x7')]=void 0x0;const fs_1=require('fs');const stripJsonComments=require(a6_0x6929('0x32'));const yargsParser=require(a6_0x6929('0x45'));const environment_1=require('../../../utilities/environment');const metric_logger_1=require(a6_0x6929('0x56'));const print_cacheable_targets_error_1=require('../../error/print-cacheable-targets-error');const print_invalid_runner_error_1=require(a6_0x6929('0x24'));const print_run_group_error_1=require(a6_0x6929('0x1f'));const distributed_agent_api_1=require(a6_0x6929('0x49'));const execute_tasks_1=require('./execute-tasks');const dte_artifact_storage_1=require('../../../utilities/dte-artifact-storage');const file_storage_1=require(a6_0x6929('0x2c'));const e2e_encryption_1=require(a6_0x6929('0x1e'));const error_reporter_api_1=require('../../api/error-reporter.api');const invoke_tasks_using_run_many_1=require(a6_0x6929('0x35'));const invoke_tasks_using_nx_imperative_api_1=require(a6_0x6929('0x28'));const is_workspace_enabled_1=require(a6_0x6929('0x37'));const {output,initTasksRunner,workspaceRoot,cacheDirectory}=require(a6_0x6929('0x42'));const args=yargsParser(process[a6_0x6929('0x38')],{'array':['targets'],'default':{}});if(args[a6_0x6929('0x17')]&&args[a6_0x6929('0x17')][a6_0x6929('0x47')]===0x1){args[a6_0x6929('0x17')]=args[a6_0x6929('0x17')][0x0][a6_0x6929('0x2f')](',')[a6_0x6929('0x29')](_0x37d48f=>_0x37d48f[a6_0x6929('0x3c')]());}function startAgent(){return __awaiter(this,void 0x0,void 0x0,function*(){const _0x8dbc8e=(0x0,environment_1[a6_0x6929('0x2')])();const _0x5735aa=(0x0,environment_1[a6_0x6929('0x52')])();const _0x7befde=(0x0,environment_1[a6_0x6929('0x53')])();const _0x24cd4c=(0x0,environment_1[a6_0x6929('0xf')])();if(!(0x0,print_run_group_error_1[a6_0x6929('0x4f')])(_0x5735aa,_0x7befde)){(0x0,print_run_group_error_1[a6_0x6929('0x5')])();process['exit'](0x1);}if(args[a6_0x6929('0x17')]&&args['targets']['length']){output[a6_0x6929('0x25')]({'title':a6_0x6929('0xe')+args[a6_0x6929('0x17')][a6_0x6929('0x23')](',\x20')+']'});}else{output['note']({'title':a6_0x6929('0x57')});}const _0x2fda43=JSON[a6_0x6929('0x51')](stripJsonComments((0x0,fs_1[a6_0x6929('0x2d')])(workspaceRoot+'/nx.json')[a6_0x6929('0x4')]()))[a6_0x6929('0x22')]['default'];if(_0x2fda43[a6_0x6929('0x59')]!==a6_0x6929('0x4b')&&_0x2fda43['runner']!==a6_0x6929('0xb')){(0x0,print_invalid_runner_error_1[a6_0x6929('0x3d')])();return process[a6_0x6929('0x26')](0x1);}const _0x32f1a6=_0x2fda43['options'];if(args[a6_0x6929('0x17')]&&args[a6_0x6929('0x17')][a6_0x6929('0x1c')](_0x3e8f81=>{var _0x501634;return!((_0x501634=_0x32f1a6['cacheableOperations'])===null||_0x501634===void 0x0?void 0x0:_0x501634['includes'](_0x3e8f81));})){const _0x2a67a1=args[a6_0x6929('0x17')][a6_0x6929('0x4d')](_0x1f9c64=>{var _0x25d91a;return!((_0x25d91a=_0x32f1a6[a6_0x6929('0xd')])===null||_0x25d91a===void 0x0?void 0x0:_0x25d91a[a6_0x6929('0x21')](_0x1f9c64));});(0x0,print_cacheable_targets_error_1['printCacheableTargetsError'])(_0x2a67a1);return process[a6_0x6929('0x26')](0x1);}const _0x1e065c=yield(0x0,is_workspace_enabled_1[a6_0x6929('0x4a')])(_0x32f1a6);if(!_0x1e065c){output['error']({'title':a6_0x6929('0x36'),'bodyLines':[a6_0x6929('0x27'),'',a6_0x6929('0x3b')]});process[a6_0x6929('0x26')](0x1);}const _0xedd047=getAgentName();const _0x237562=new distributed_agent_api_1[(a6_0x6929('0x16'))](_0x32f1a6,_0x8dbc8e,_0x5735aa,_0x7befde,_0x24cd4c,_0xedd047);createAgentLockfileAndSetUpListeners(_0x237562,_0x32f1a6,_0xedd047);const _0x3f9023=new e2e_encryption_1[(a6_0x6929('0x1'))](environment_1[a6_0x6929('0x1a')]||_0x32f1a6[a6_0x6929('0x1b')]);const _0x4e12e3=new error_reporter_api_1[(a6_0x6929('0x2b'))](_0x32f1a6);const _0x1aa783=new dte_artifact_storage_1[(a6_0x6929('0x55'))](new file_storage_1[(a6_0x6929('0xa'))](_0x3f9023,_0x4e12e3,_0x32f1a6,'dte-agent'),cacheDirectory);const _0xa3da46=initTasksRunner?yield(0x0,invoke_tasks_using_nx_imperative_api_1['invokeTasksUsingNxImperativeApi'])(_0x32f1a6):yield(0x0,invoke_tasks_using_run_many_1['invokeTasksUsingRunMany'])();return(0x0,execute_tasks_1[a6_0x6929('0x43')])(_0xedd047,_0x237562,_0x1aa783,_0xa3da46,args['targets'])[a6_0x6929('0x6')](_0x104ae8=>__awaiter(this,void 0x0,void 0x0,function*(){yield(0x0,metric_logger_1[a6_0x6929('0x41')])(_0x32f1a6);return _0x104ae8;}))['catch'](_0x478d36=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x237562[a6_0x6929('0x13')](a6_0x6929('0x1d')+_0x478d36[a6_0x6929('0x33')]+'\x22');throw _0x478d36;}));});}exports[a6_0x6929('0x7')]=startAgent;function getAgentName(){if(process[a6_0x6929('0x14')][a6_0x6929('0x34')]!==undefined){return process['env'][a6_0x6929('0x34')];}else if(process[a6_0x6929('0x14')][a6_0x6929('0xc')]!==undefined&&process[a6_0x6929('0x14')][a6_0x6929('0x18')]){return process['env']['CIRCLE_STAGE'];}else if(process[a6_0x6929('0x14')][a6_0x6929('0xc')]!==undefined&&process[a6_0x6929('0x14')][a6_0x6929('0x48')]){return process[a6_0x6929('0x14')][a6_0x6929('0x48')];}else{return a6_0x6929('0x8')+Math[a6_0x6929('0x20')](Math[a6_0x6929('0x0')]()*0x186a0);}}function createAgentLockfileAndSetUpListeners(_0x29eefb,_0x2cf3ab,_0xa8f37){const _0xd70e07=cacheDirectory+a6_0x6929('0x9');const _0x10f79e=_0xd70e07+'/'+_0xa8f37+a6_0x6929('0x10');if(!(0x0,fs_1[a6_0x6929('0x3a')])(_0xd70e07)){(0x0,fs_1['mkdirSync'])(_0xd70e07,{'recursive':!![]});}const _0x4e9388=(0x0,fs_1[a6_0x6929('0x15')])(_0xd70e07);if(_0x4e9388[a6_0x6929('0x47')]){if(_0x4e9388[a6_0x6929('0x21')](_0xa8f37+'.lock')){output[a6_0x6929('0x4c')]({'title':a6_0x6929('0x5a'),'bodyLines':[a6_0x6929('0x3f'),'',a6_0x6929('0x2a')]});process[a6_0x6929('0x26')](0x1);}output[a6_0x6929('0x3')]({'title':a6_0x6929('0x31'),'bodyLines':[a6_0x6929('0x30'),'',a6_0x6929('0x4e'),a6_0x6929('0x11')]});}(0x0,fs_1[a6_0x6929('0x54')])(_0x10f79e,'');process['on']('exit',_0x488c3e=>{cleanupAgentLockfile(_0x10f79e,_0x488c3e);});process['on']('SIGTERM',()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x29eefb[a6_0x6929('0x13')](a6_0x6929('0x58'));cleanupAgentLockfile(_0x10f79e,0x1);}));process['on'](a6_0x6929('0x40'),()=>__awaiter(this,void 0x0,void 0x0,function*(){yield _0x29eefb['completeRunGroupWithError'](a6_0x6929('0x39'));cleanupAgentLockfile(_0x10f79e,0x1);}));}function cleanupAgentLockfile(_0x747b54,_0x49b4ee){if((0x0,fs_1[a6_0x6929('0x3a')])(_0x747b54)){(0x0,fs_1[a6_0x6929('0x12')])(_0x747b54);process[a6_0x6929('0x26')](_0x49b4ee);}}