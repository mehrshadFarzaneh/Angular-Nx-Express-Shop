"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.addToNgModule = exports.findModule = void 0;
const devkit_1 = require("@nx/devkit");
const path_1 = require("path");
const ensure_typescript_1 = require("@nx/js/src/utils/typescript/ensure-typescript");
const js_1 = require("@nx/js");
const insert_ngmodule_import_1 = require("./insert-ngmodule-import");
let tsModule;
function findModule(tree, path, module) {
    let modulePath = '';
    let pathToSearch = path;
    while (pathToSearch !== '.' && pathToSearch !== '/') {
        if (module) {
            const pathToModule = (0, devkit_1.joinPathFragments)(pathToSearch, module);
            if (tree.exists(pathToModule)) {
                modulePath = pathToModule;
                break;
            }
        }
        else {
            const potentialOptions = tree
                .children(pathToSearch)
                .filter((f) => f.endsWith('.module.ts'));
            if (potentialOptions.length > 1) {
                throw new Error(`More than one NgModule was found. Please provide the NgModule you wish to use.`);
            }
            else if (potentialOptions.length === 1) {
                modulePath = (0, devkit_1.joinPathFragments)(pathToSearch, potentialOptions[0]);
                break;
            }
        }
        pathToSearch = (0, path_1.dirname)(pathToSearch);
    }
    if (modulePath === '') {
        throw new Error('Could not find a declaring module file.');
    }
    const moduleContents = tree.read(modulePath, 'utf-8');
    if (!moduleContents.includes('@NgModule')) {
        throw new Error(`Declaring module file (${modulePath}) does not contain an @NgModule Declaration.`);
    }
    return modulePath;
}
exports.findModule = findModule;
function addToNgModule(tree, path, modulePath, name, className, fileName, ngModuleProperty, isFlat = true, isExported = false) {
    if (!tsModule) {
        tsModule = (0, ensure_typescript_1.ensureTypescript)();
    }
    let relativePath = `${(0, devkit_1.joinPathFragments)(path.replace((0, path_1.dirname)(modulePath), ''), !isFlat ? name : '', `${fileName}`)}`;
    relativePath = relativePath.startsWith('/')
        ? `.${relativePath}`
        : `./${relativePath}`;
    const moduleContents = tree.read(modulePath, 'utf-8');
    const source = tsModule.createSourceFile(modulePath, moduleContents, tsModule.ScriptTarget.Latest, true);
    (0, js_1.insertImport)(tree, source, modulePath, className, relativePath);
    (0, insert_ngmodule_import_1.insertNgModuleProperty)(tree, modulePath, className, ngModuleProperty);
    if (isExported) {
        (0, insert_ngmodule_import_1.insertNgModuleProperty)(tree, modulePath, className, 'exports');
    }
}
exports.addToNgModule = addToNgModule;
