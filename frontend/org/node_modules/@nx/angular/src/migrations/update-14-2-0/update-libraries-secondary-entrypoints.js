"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const devkit_1 = require("@nx/devkit");
const path_1 = require("path");
const libraryExecutors = [
    '@angular-devkit/build-angular:ng-packagr',
    '@nrwl/angular:ng-packagr-lite',
    '@nrwl/angular:package',
];
function default_1(tree) {
    var _a;
    return tslib_1.__awaiter(this, void 0, void 0, function* () {
        const projects = (0, devkit_1.getProjects)(tree);
        for (const [, project] of projects) {
            if (!Object.values((_a = project.targets) !== null && _a !== void 0 ? _a : {}).some((target) => libraryExecutors.includes(target.executor))) {
                continue;
            }
            (0, devkit_1.visitNotIgnoredFiles)(tree, project.root, (filePath) => {
                if ((0, path_1.basename)(filePath) !== 'package.json' ||
                    (0, devkit_1.normalizePath)(filePath) ===
                        (0, devkit_1.joinPathFragments)(project.root, 'package.json')) {
                    return;
                }
                const json = (0, devkit_1.readJson)(tree, filePath);
                if (json.ngPackage) {
                    // Migrate ng-packagr config to an ng-packagr config file.
                    const configFilePath = (0, devkit_1.joinPathFragments)((0, path_1.dirname)(filePath), 'ng-package.json');
                    (0, devkit_1.writeJson)(tree, configFilePath, json.ngPackage);
                }
                // Delete package.json as it is no longer needed in APF 14.
                tree.delete(filePath);
            });
        }
        yield (0, devkit_1.formatFiles)(tree);
    });
}
exports.default = default_1;
